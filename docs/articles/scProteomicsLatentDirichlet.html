<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Latent Dirichlet Allocation to Integrate Single-Cell Targeted Proteomics Data â€¢ BIRSBIO2020scProteomicsLDA</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Latent Dirichlet Allocation to Integrate Single-Cell Targeted Proteomics Data">
<meta property="og:description" content="BIRSBIO2020scProteomicsLDA">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">BIRSBIO2020scProteomicsLDA</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/scProteomicsLatentDirichlet.html">Latent Dirichlet Allocation to Integrate Single-Cell Targeted Proteomics Data</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Latent Dirichlet Allocation to Integrate Single-Cell Targeted Proteomics Data</h1>
                        <h4 class="author">Prathee Jeganathan<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>
</h4>
            
      
      
      <div class="hidden name"><code>scProteomicsLatentDirichlet.Rmd</code></div>

    </div>

    
    
<p>We use this R Markdown to run the topic modeling.</p>
<p>We use iterations 100 for this vignette, but the results for iterations 2000 is available.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="no">K</span> <span class="kw">&lt;-</span> <span class="fl">5</span>
<span class="no">K</span></pre></body></html></div>
<pre><code>## [1] 5</code></pre>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">iter</span> <span class="kw">&lt;-</span> <span class="fl">100</span>
<span class="no">iter</span></pre></body></html></div>
<pre><code>## [1] 100</code></pre>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">SingleCellExperiment</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rstan</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">plyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">reshape2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">readr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">magrittr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">MultiAssayExperiment</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">DESeq2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">abind</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tibble</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">RColorBrewer</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">raster</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">stringr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggthemes</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">pheatmap</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">gtools</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">uwot</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">gridExtra</span>)</pre></body></html></div>
<div id="cytof" class="section level1">
<h1 class="hasAnchor">
<a href="#cytof" class="anchor"></a>CyTOF</h1>
<ul>
<li>Wagner 2018 Cytof
<ul>
<li>140 breast cancer patients; Of 140, 6 tripple negative (TN)</li>
<li>cd45_sce_dropna$Clinical.Subtype == "TN</li>
<li>3 cancer-free</li>
<li>73 protein markers in immune-centric and tumor-centric microenvironment</li>
</ul>
</li>
<li>Keren 2018 Multiplex Ion Bean Imaging (MIBI)
<ul>
<li>Tumor-immune microenvironment in TN patients</li>
<li>41 TN patients</li>
<li>36 proteins</li>
</ul>
</li>
</ul>
<p>We will choose patients with TN with immune and tumor cells in both CyTOF and MIBI for the integrative analysis.</p>
</div>
<div id="mass-tag-cytof-breast-cancer-data" class="section level1">
<h1 class="hasAnchor">
<a href="#mass-tag-cytof-breast-cancer-data" class="anchor"></a>Mass-Tag CyTOF Breast Cancer Data</h1>
<ul>
<li>For this analysis we use <strong>cd45.sce</strong>: CD45+ cells from the live cells; downsampled to 426,872 cells (assayed on immune panel) <span class="math inline">\(\times\)</span> 35 proteins</li>
</ul>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="st">"masstagSCE.rda"</span>)
<span class="no">cd45.sce</span> <span class="co"># 38 * 426872</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="no">epith.sce</span>, <span class="no">livecells.sce</span>, <span class="no">myeloid.sce</span>, <span class="no">tcell.sce</span>)</pre></body></html></div>
<p>Drop the five subjects without any clinical data. We can use Gender variable to identify those subjects</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html">unique</a></span>(<span class="fu">colData</span>(<span class="no">cd45.sce</span>)$<span class="no">patient_id.y</span>[<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="fu">colData</span>(<span class="no">cd45.sce</span>)$<span class="no">Gender</span>))])

<span class="no">cd45_to_keep</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="fu">colData</span>(<span class="no">cd45.sce</span>)$<span class="no">Gender</span>))
<span class="no">cd45.sce_dropna</span> <span class="kw">&lt;-</span> <span class="no">cd45.sce</span>[,<span class="no">cd45_to_keep</span>]
<span class="no">cd45.sce_dropna</span> <span class="co"># 38 * 420685</span>
<span class="co"># To verify there are no (true) NA's left:</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="fu">rowData</span>(<span class="no">cd45.sce_dropna</span>)))
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="no">cd45.sce</span>, <span class="no">cd45_to_keep</span>)

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="no">cd45.sce_dropna</span>, <span class="st">"cd45_sce_dropna.rds"</span>)</pre></body></html></div>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">cd45_sce</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"cd45_sce_dropna.rds"</span>)
<span class="no">cd45_sce</span></pre></body></html></div>
<p>There are three proteins without gene symbol in cd45_sce_dropna so we drop them (non-protein channels for cisplatin and DNA tags that are included)</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">cd45_sce</span> <span class="kw">&lt;-</span> <span class="no">cd45_sce</span>[!(<span class="fu">rowData</span>(<span class="no">cd45_sce</span>)$<span class="no">hgnc_symbol</span> <span class="kw">==</span> <span class="st">"na"</span>) ,]
<span class="no">cd45_sce</span></pre></body></html></div>
<p>There are two different health status</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="fu">colData</span>(<span class="no">cd45_sce</span>)$<span class="no">Health.Status</span>)</pre></body></html></div>
<p>There are five different clinical subtypes of cancer patients, including TN and healthy</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="fu">colData</span>(<span class="no">cd45_sce</span>)$<span class="no">Clinical.Subtype</span>)</pre></body></html></div>
<p>Subset TN clinical subtype</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">cd45_sce</span> <span class="kw">&lt;-</span> <span class="no">cd45_sce</span>[, <span class="no">cd45_sce</span>$<span class="no">Clinical.Subtype</span> <span class="kw">==</span> <span class="st">"TN"</span>]
<span class="no">cd45_sce</span>
<span class="co">#drop cells(columns) with no protein expression</span>
<span class="no">cd45_sce</span> <span class="kw">&lt;-</span> <span class="no">cd45_sce</span>[, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/rowSums.html">colSums</a></span>(<span class="fu">assay</span>(<span class="no">cd45_sce</span>)) <span class="kw">&gt;</span> <span class="fl">0</span>]
<span class="no">cd45_sce</span>
<span class="co"># drop levels of patient_id.x</span>
<span class="no">cd45_sce</span>$<span class="no">patient_id.x</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html">droplevels</a></span>(<span class="no">cd45_sce</span>$<span class="no">patient_id.x</span>)</pre></body></html></div>
<p>There are six TN patients and two had previous cancer incidence</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">cd45_sce</span>$<span class="no">Previous.Cancer.Incidences</span>, <span class="no">cd45_sce</span>$<span class="no">patient_id.x</span>)</pre></body></html></div>
<p>Letâ€™s choose subject BB028 and will see whether we can infer co-location of immune cells.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">cd45_sce</span> <span class="kw">&lt;-</span> <span class="no">cd45_sce</span>[ , <span class="no">cd45_sce</span>$<span class="no">patient_id.x</span> <span class="kw">==</span> <span class="st">"BB028"</span>]
<span class="no">cd45_sce</span></pre></body></html></div>
<p>Add cell idâ€™s to CyTOF</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">cd45_sce</span>$<span class="no">cell_id</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"cytof_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">cd45_sce</span>)[<span class="fl">2</span>]))
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">cd45_sce</span>) <span class="kw">&lt;-</span> <span class="no">cd45_sce</span>$<span class="no">cell_id</span></pre></body></html></div>
<p>heatmap</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">or</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span>(<span class="fu">assay</span>(<span class="no">cd45_sce</span>)), <span class="kw">decreasing</span><span class="kw">=</span><span class="fl">TRUE</span>)
<span class="no">ass</span> <span class="kw">&lt;-</span> <span class="fu">assay</span>(<span class="no">cd45_sce</span>)[<span class="no">or</span>, ]

<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span>(<span class="fu">colData</span>(<span class="no">cd45_sce</span>)[<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">ass</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"patient_id.x"</span>, <span class="st">"Menopause.Status"</span>, <span class="st">"Previous.Cancer.Incidences"</span>, <span class="st">"HER2.IHC.Score"</span> ,<span class="st">"cell_id"</span>)])

<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">df</span>, <span class="no">df</span>[<span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="no">patient_id.x</span>, <span class="no">Menopause.Status</span>, <span class="no">Previous.Cancer.Incidences</span>, <span class="no">HER2.IHC.Score</span>, <span class="no">cell_id</span>),])
<span class="no">ass</span> <span class="kw">&lt;-</span> <span class="no">ass</span>[, <span class="no">df</span>$<span class="no">cell_id</span>]
<span class="no">df</span> <span class="kw">&lt;-</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">df</span>, -<span class="no">cell_id</span>)

<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">ass</span>) <span class="kw">&lt;-</span> <span class="fu">rowData</span>(<span class="no">cd45_sce</span>)$<span class="no">marker_name</span>[<span class="no">or</span>]

<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html">pheatmap</a></span>(<span class="no">ass</span>,
              <span class="kw">annotation_col</span> <span class="kw">=</span> <span class="no">df</span>,
              <span class="kw">cluster_rows</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
              <span class="kw">cluster_cols</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
              <span class="kw">fontsize_row</span> <span class="kw">=</span> <span class="fl">14</span>,
              <span class="kw">fontsize_col</span> <span class="kw">=</span> <span class="fl">14</span>,
              <span class="kw">show_colnames</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></body></html></div>
</div>
<div id="keren-et-al--mibi-tof-breast-cancer-data" class="section level1">
<h1 class="hasAnchor">
<a href="#keren-et-al--mibi-tof-breast-cancer-data" class="anchor"></a>Keren et al., MIBI-TOF Breast Cancer Data</h1>
<ul>
<li>All 39 patients were TN</li>
<li>The size-normalized raw intensity values are then arcsinh transformed and standardized across the markers.</li>
</ul>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="st">'mibiSCE.rda'</span>)
<span class="no">mibi.sce</span>

<span class="fu"><a href="https://rdrr.io/pkg/DESeq2/man/summary.html">summary</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span>(<span class="fu">assay</span>(<span class="no">mibi.sce</span>)))
<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span>(<span class="fu">assay</span>(<span class="no">mibi.sce</span>))
<span class="fu">rowSds</span>(<span class="fu">assay</span>(<span class="no">mibi.sce</span>))
<span class="fu">rowMax</span>(<span class="fu">assay</span>(<span class="no">mibi.sce</span>))</pre></body></html></div>
<p>Rows correspond to channels and columns correspond to cells. We can see all of the channels that were collected in this experiment:</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">mibi.sce</span>)</pre></body></html></div>
<p>The 38 proteins can be easily identified by using the binary attribute is_protein from rowData (The other 11 comprise background, experimental controls (e.g, Au and dsDNA), and elements of potential interest in studying cellular mechanisms (e.g., Ca, Fe; relevant in other spatial studies))</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">mibi.sce_proteins</span> <span class="kw">&lt;-</span> <span class="no">mibi.sce</span>[<span class="fu">rowData</span>(<span class="no">mibi.sce</span>)$<span class="no">is_protein</span> <span class="kw">==</span> <span class="fl">1</span>,]
<span class="no">mibi.sce_proteins</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="no">mibi.sce</span>)

<span class="fu"><a href="https://rdrr.io/pkg/DESeq2/man/summary.html">summary</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span>(<span class="fu">assay</span>(<span class="no">mibi.sce_proteins</span>)))
<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span>(<span class="fu">assay</span>(<span class="no">mibi.sce_proteins</span>))
<span class="fu">rowSds</span>(<span class="fu">assay</span>(<span class="no">mibi.sce_proteins</span>))
<span class="fu">rowMax</span>(<span class="fu">assay</span>(<span class="no">mibi.sce_proteins</span>))</pre></body></html></div>
<p>Cell type information is availble in the columns <em>tumor_group</em> and <em>immune_group</em> . That is, 51% of cells were Keratin positive tumor cells and 41% of cells were immune cells.</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">mibi.sce_proteins</span>$<span class="no">tumor_group</span>)/<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">ncol</a></span>(<span class="no">mibi.sce_proteins</span>),<span class="fl">2</span>)</pre></body></html></div>
<p>Among the immune cells, macrophages and CD8, CD4+ T-cells and other immune cells were identified. 10% of all cells assayed were macrophages</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="co"># Immune Cells</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">mibi.sce_proteins</span>$<span class="no">immune_group</span>)/<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">ncol</a></span>(<span class="no">mibi.sce_proteins</span>),<span class="fl">2</span>)</pre></body></html></div>
<p>Consider Keratin positive tumor cells and immune cells (there are different immune cell types within immune cells)</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="fu">colData</span>(<span class="no">mibi.sce_proteins</span>)$<span class="no">tumor_group</span>)
<span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="fu">colData</span>(<span class="no">mibi.sce_proteins</span>)$<span class="no">tumor_group</span>, <span class="fu">colData</span>(<span class="no">mibi.sce_proteins</span>)$<span class="no">immune_group</span>)

<span class="no">mibi.sce_proteins</span> <span class="kw">&lt;-</span> <span class="no">mibi.sce_proteins</span>[, <span class="fu">colData</span>(<span class="no">mibi.sce_proteins</span>)$<span class="no">tumor_group</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Immune"</span>, <span class="st">"Keratin-positive tumor"</span>)]</pre></body></html></div>
<p>heatmap of protein expression in tumor and immune cells</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">mibi</span> <span class="kw">&lt;-</span> <span class="no">mibi.sce_proteins</span>
<span class="no">mibi</span>
<span class="co">#drop cells(columns) with no protein expression</span>
<span class="no">mibi</span> <span class="kw">&lt;-</span> <span class="no">mibi</span>[, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/rowSums.html">colSums</a></span>(<span class="fu">assay</span>(<span class="no">mibi</span>)) <span class="kw">&gt;</span> <span class="fl">0</span>]
<span class="no">mibi</span>
<span class="co">#drop proteins(rows) with no expression in any of these cells</span>
<span class="no">mibi</span> <span class="kw">&lt;-</span> <span class="no">mibi</span>[<span class="fu"><a href="https://rdrr.io/pkg/raster/man/rowSums.html">rowSums</a></span>(<span class="fu">assay</span>(<span class="no">mibi</span>)) <span class="kw">&gt;</span> <span class="fl">0</span>, ]
<span class="no">mibi</span></pre></body></html></div>
<p>rowData(mibi) doesnâ€™t have cell IDs, so we add it.</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="fu">colData</span>(<span class="no">mibi</span>)$<span class="no">cell_id</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"mibi_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">mibi</span>)[<span class="fl">2</span>]))
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">mibi</span>) <span class="kw">&lt;-</span> <span class="fu">colData</span>(<span class="no">mibi</span>)$<span class="no">cell_id</span>
<span class="no">mibi</span>$<span class="no">DONOR_NO</span> <span class="kw">&lt;-</span> <span class="no">mibi</span>$<span class="no">DONOR_NO</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.character.html">as.character</a></span>()</pre></body></html></div>
<p>There are mibi$SampleID 42, 43, 44 with no DONOR_NO, remove cells from these SampleIDs</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="no">mibi</span> <span class="kw">&lt;-</span> <span class="no">mibi</span>[, !(<span class="no">mibi</span>$<span class="no">SampleID</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"42"</span>, <span class="st">"43"</span>, <span class="st">"44"</span>))]
<span class="no">mibi</span></pre></body></html></div>
</div>
<div id="heatmap" class="section level1">
<h1 class="hasAnchor">
<a href="#heatmap" class="anchor"></a>heatmap</h1>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="no">or</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span>(<span class="fu">assay</span>(<span class="no">mibi</span>)), <span class="kw">decreasing</span><span class="kw">=</span><span class="fl">TRUE</span>)

<span class="no">g</span> <span class="kw">&lt;-</span> <span class="no">mibi</span>$<span class="no">DONOR_NO</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>()
<span class="no">choose_by_patient</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span>(<span class="fu">colData</span>(<span class="no">mibi</span>)<span class="kw">%&gt;%</span> <span class="no">data.frame</span>, <span class="no">g</span>)
<span class="no">sample_by_patient</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">choose_by_patient</span>)), <span class="fl">5</span>)


<span class="no">no_cells_per_patient</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">mibi</span>$<span class="no">DONOR_NO</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>()
<span class="no">no_cells_per_patient</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">no_cells_per_patient</span>$<span class="no">Freq</span>)
<span class="no">no_cells_sample</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">no_cells_per_patient</span>, <span class="fl">1</span>, <span class="kw">function</span>(<span class="no">y</span>){
  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="fl">50</span>, <span class="no">y</span>)
})

<span class="no">patient_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">choose_by_patient</span>)))

<span class="no">choose_by_patient_cells</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">patient_list</span>, <span class="kw">function</span>(<span class="no">x</span>){
  <span class="no">sample_cell_ids</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span>(<span class="no">choose_by_patient</span><span class="kw">[[</span><span class="no">x</span>]]$<span class="no">cell_id</span>, <span class="no">no_cells_sample</span>[<span class="no">x</span>])

  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">sample_cell_ids</span>)

})
<span class="no">choose_by_patient_cells</span> <span class="kw">&lt;-</span> <span class="no">choose_by_patient_cells</span>[<span class="no">sample_by_patient</span>]

<span class="no">choose_by_patient_cells</span> <span class="kw">&lt;-</span> <span class="no">choose_by_patient_cells</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>()
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span>(<span class="no">choose_by_patient_cells</span>) <span class="kw">&lt;-</span> <span class="kw">NULL</span>

<span class="no">ass</span> <span class="kw">&lt;-</span> <span class="fu">assay</span>(<span class="no">mibi</span>)[<span class="no">or</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">mibi</span>$<span class="no">cell_id</span> <span class="kw">%in%</span>  <span class="no">choose_by_patient_cells</span>)]


<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span>(<span class="fu">colData</span>(<span class="no">mibi</span>)[<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">ass</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"DONOR_NO"</span>, <span class="st">"tumor_group"</span>, <span class="st">"immune_group"</span>,<span class="st">"cell_id"</span>)])

<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">df</span>, <span class="no">df</span>[<span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="no">DONOR_NO</span>, <span class="no">tumor_group</span>, <span class="no">immune_group</span>,<span class="no">cell_id</span>), ])
<span class="no">ass</span> <span class="kw">&lt;-</span> <span class="no">ass</span>[, <span class="no">df</span>$<span class="no">cell_id</span>]
<span class="no">df</span> <span class="kw">&lt;-</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">df</span>, -<span class="no">cell_id</span>)

<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">ass</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="fu">rowData</span>(<span class="no">mibi</span>))[<span class="no">or</span>]

<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html">pheatmap</a></span>(<span class="no">ass</span>,
              <span class="kw">annotation_col</span> <span class="kw">=</span> <span class="no">df</span>,
              <span class="kw">cluster_rows</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
              <span class="kw">cluster_cols</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
              <span class="kw">fontsize_row</span> <span class="kw">=</span> <span class="fl">14</span>,
              <span class="kw">fontsize_col</span> <span class="kw">=</span> <span class="fl">14</span>,
              <span class="kw">show_colnames</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></body></html></div>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="no">cell_type</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="no">mibi</span>$<span class="no">immune_group</span> <span class="kw">!=</span> <span class="st">"not immune"</span>, <span class="no">mibi</span>$<span class="no">immune_group</span>, <span class="st">"Tumor"</span>)
<span class="no">mibi</span>$<span class="no">cell_type</span> <span class="kw">&lt;-</span> <span class="no">cell_type</span></pre></body></html></div>
</div>
<div id="add-spatial-location" class="section level1">
<h1 class="hasAnchor">
<a href="#add-spatial-location" class="anchor"></a>Add spatial location</h1>
<p>Because we already run this code, we read the saved mae with spatial information</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="no">tiff_file_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="st">"TNBC_shareCellData/"</span>, <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">".tiff"</span>)

<span class="no">mibi_sample_id_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
<span class="kw">for</span>(<span class="no">id</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">tiff_file_list</span>)){
    <span class="no">str_name</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"TNBC_shareCellData/"</span>, <span class="no">tiff_file_list</span>[<span class="no">id</span>], <span class="kw">sep</span> <span class="kw">=</span> <span class="st">""</span>)

    <span class="no">sample_id</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"p"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"_labeledcellData.tiff"</span>, <span class="st">""</span>, <span class="no">tiff_file_list</span>[<span class="no">id</span>])))

    <span class="no">r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span>(<span class="no">str_name</span>)

    <span class="no">mibi_sample_id_list</span><span class="kw">[[</span><span class="no">id</span>]] <span class="kw">&lt;-</span> <span class="no">mibi</span>[, <span class="no">mibi</span>$<span class="no">SampleID</span> <span class="kw">==</span> <span class="no">sample_id</span>]

    <span class="no">df_rP</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/rasterToPoints.html">rasterToPoints</a></span>(<span class="no">r</span>)
    <span class="no">df_rP</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">df_rP</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">df_rP</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"X"</span>, <span class="st">"Y"</span>, <span class="st">"values"</span>)
    <span class="no">noise_not_in_mibi</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html">unique</a></span>(<span class="no">df_rP</span>$<span class="no">values</span>[!<span class="no">df_rP</span>$<span class="no">values</span> <span class="kw">%in%</span> <span class="no">mibi_sample_id_list</span><span class="kw">[[</span><span class="no">id</span>]]$<span class="no">cellLabelInImage</span>])

    <span class="co"># compute centroid of each cell</span>
    <span class="no">centroid_X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/aggregate.html">aggregate</a></span>(<span class="no">df_rP</span>[,<span class="fl">1</span>], <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">df_rP</span>[,<span class="fl">3</span>]), <span class="kw">FUN</span> <span class="kw">=</span> <span class="no">median</span>)
    <span class="no">centroid_Y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/aggregate.html">aggregate</a></span>(<span class="no">df_rP</span>[,<span class="fl">2</span>], <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">df_rP</span>[,<span class="fl">3</span>]), <span class="kw">FUN</span> <span class="kw">=</span> <span class="no">median</span>)
    <span class="no">centroid_XY</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">centroid_X</span> <span class="kw">=</span> <span class="no">centroid_X</span>$<span class="no">x</span>, <span class="kw">centroid_Y</span> <span class="kw">=</span> <span class="no">centroid_Y</span>$<span class="no">x</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">centroid_X</span>$<span class="no">Group.1</span>)
    <span class="no">cell_label_with_bg_XY</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mapvalues.html">mapvalues</a></span>((<span class="no">centroid_XY</span>$<span class="no">group</span>), <span class="kw">from</span> <span class="kw">=</span> <span class="no">noise_not_in_mibi</span>, <span class="kw">to</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">noise_not_in_mibi</span>)))

    <span class="no">cell_label_with_bg_XY</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mapvalues.html">mapvalues</a></span>((<span class="no">cell_label_with_bg_XY</span>), <span class="kw">from</span> <span class="kw">=</span> <span class="no">mibi_sample_id_list</span><span class="kw">[[</span><span class="no">id</span>]]$<span class="no">cellLabelInImage</span>, <span class="kw">to</span> <span class="kw">=</span> <span class="no">mibi_sample_id_list</span><span class="kw">[[</span><span class="no">id</span>]]$<span class="no">cell_type</span>)
    <span class="no">centroid_XY</span>$<span class="no">cell_label_with_bg_XY</span> <span class="kw">&lt;-</span> <span class="no">cell_label_with_bg_XY</span>

    <span class="co"># filter the center info without cells </span>
    <span class="no">centroid_XY</span> <span class="kw">&lt;-</span> <span class="no">centroid_XY</span>[<span class="no">centroid_XY</span>$<span class="no">cell_label_with_bg_XY</span> <span class="kw">!=</span> <span class="st">"0"</span>, ]


    <span class="no">dd_sample_id</span> <span class="kw">&lt;-</span> <span class="fu">colData</span>(<span class="no">mibi_sample_id_list</span><span class="kw">[[</span><span class="no">id</span>]]) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>()
    <span class="no">dd_sample_id</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(<span class="no">dd_sample_id</span>, <span class="no">centroid_XY</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cellLabelInImage"</span> <span class="kw">=</span> <span class="st">"group"</span>))
    <span class="no">mibi_sample_id_list</span><span class="kw">[[</span><span class="no">id</span>]]$<span class="no">centroid_X</span> <span class="kw">&lt;-</span> <span class="no">dd_sample_id</span>$<span class="no">centroid_X</span>
    <span class="no">mibi_sample_id_list</span><span class="kw">[[</span><span class="no">id</span>]]$<span class="no">centroid_Y</span> <span class="kw">&lt;-</span> <span class="no">dd_sample_id</span>$<span class="no">centroid_Y</span>
}

<span class="no">mibi_spa</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">mibi_sample_id_list</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="no">mibi_sample_id_list</span><span class="kw">[[</span><span class="fl">2</span>]])
<span class="kw">for</span>(<span class="no">id</span> <span class="kw">in</span> <span class="fl">3</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">tiff_file_list</span>)){

 <span class="no">mibi_spa</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">mibi_spa</span>, <span class="no">mibi_sample_id_list</span><span class="kw">[[</span><span class="no">id</span>]])
}

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="no">mibi_spa</span>, <span class="kw">file</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"../Results/mibi_spa.rds"</span>))</pre></body></html></div>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="no">mibi</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"mibi_spa.rds"</span>)</pre></body></html></div>
<p>Consider one DONOR from mibi</p>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="no">mibi</span> <span class="kw">&lt;-</span> <span class="no">mibi</span>[, <span class="no">mibi</span>$<span class="no">DONOR_NO</span> <span class="kw">%in%</span> <span class="st">"30824"</span>]
<span class="no">mibi</span>

<span class="co">#drop proteins(rows) with no expression in any of these cells</span>
<span class="no">mibi</span> <span class="kw">&lt;-</span> <span class="no">mibi</span>[<span class="fu"><a href="https://rdrr.io/pkg/raster/man/rowSums.html">rowSums</a></span>(<span class="fu">assay</span>(<span class="no">mibi</span>)) <span class="kw">&gt;</span> <span class="fl">0</span>, ]
<span class="no">mibi</span></pre></body></html></div>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="co">#drop proteins(rows) with no expression in any of these cells</span>
<span class="no">cd45_sce</span> <span class="kw">&lt;-</span> <span class="no">cd45_sce</span>[<span class="fu"><a href="https://rdrr.io/pkg/raster/man/rowSums.html">rowSums</a></span>(<span class="fu">assay</span>(<span class="no">cd45_sce</span>)) <span class="kw">&gt;</span> <span class="fl">0</span>, ]
<span class="no">cd45_sce</span></pre></body></html></div>
</div>
<div id="multiplicative-error-due-to-different-scales" class="section level1">
<h1 class="hasAnchor">
<a href="#multiplicative-error-due-to-different-scales" class="anchor"></a>Multiplicative error due to different scales</h1>
<p>cd45_sce asinh transformation with cofactor 5</p>
<div class="sourceCode" id="cb32"><html><body><pre class="r"><span class="no">inv_func</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="fl">5</span>*<span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html">sinh</a></span>(<span class="no">x</span>)
}
<span class="no">cd45_sce_inv</span> <span class="kw">&lt;-</span> <span class="no">cd45_sce</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="no">cd45_sce</span>)
<span class="fu">assay</span>(<span class="no">cd45_sce_inv</span>) <span class="kw">&lt;-</span> <span class="fu">inv_func</span>(<span class="fu">assay</span>(<span class="no">cd45_sce_inv</span>))</pre></body></html></div>
<div id="converting-each-scale-to-have-the-same-lower-and-upper-levels" class="section level2">
<h2 class="hasAnchor">
<a href="#converting-each-scale-to-have-the-same-lower-and-upper-levels" class="anchor"></a>Converting each scale to have the same lower and upper levels</h2>
<p><span class="math inline">\(y = \left(\dfrac{x-x_{\text{min}}}{x_{\text{range}}}\right) \times u\)</span>, where <span class="math inline">\(u\)</span> is the upper limit of the rescaled variable.</p>
<p>We will scale cd45 and mibi to upper limit of cd45</p>
<div class="sourceCode" id="cb33"><html><body><pre class="r"><span class="no">u</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="fu">assay</span>(<span class="no">cd45_sce_inv</span>))
<span class="no">x_mibi</span> <span class="kw">&lt;-</span> <span class="fu">assay</span>(<span class="no">mibi</span>)
<span class="no">y_mibi</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">x_mibi</span>, <span class="fl">1</span>, <span class="kw">function</span>(<span class="no">x</span>){
  <span class="no">xmin</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">x</span>)
  <span class="no">xrange</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">x</span>) - <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">x</span>)
  <span class="no">y</span> <span class="kw">&lt;-</span> (<span class="no">x</span>-<span class="no">xmin</span>)/<span class="no">xrange</span>*<span class="no">u</span>
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">y</span>)
})
<span class="no">y_mibi</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/transpose.html">t</a></span>(<span class="no">y_mibi</span>)

<span class="co">#y_mibi[is.na(y_mibi)] &lt;- 0</span>
<span class="fu">assay</span>(<span class="no">mibi</span>) <span class="kw">&lt;-</span> <span class="no">y_mibi</span></pre></body></html></div>
</div>
</div>
<div id="merge-two-singlecellexperiment-objects-and-make-mae" class="section level1">
<h1 class="hasAnchor">
<a href="#merge-two-singlecellexperiment-objects-and-make-mae" class="anchor"></a>Merge two SingleCellExperiment objects and make mae</h1>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"../R/makeMAEfromSCE.R"</span>)
<span class="no">mae</span> <span class="kw">&lt;-</span> <span class="fu">makeMAEfromSCE</span>(<span class="kw">sce_list</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">cd45_sce_inv</span>, <span class="no">mibi</span>),
                      <span class="kw">name_assays</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cd45"</span>, <span class="st">"mibi"</span>),
                      <span class="kw">sampleID_name</span> <span class="kw">=</span> <span class="st">"cell_ID"</span>)
<span class="no">mae</span></pre></body></html></div>
</div>
<div id="join-the-assays-and-impute" class="section level1">
<h1 class="hasAnchor">
<a href="#join-the-assays-and-impute" class="anchor"></a>Join the assays and impute</h1>
<p>We already run this code, we read the imputed data</p>
<div class="sourceCode" id="cb35"><html><body><pre class="r"><span class="no">x1</span> <span class="kw">&lt;-</span> <span class="fu">assay</span>(<span class="no">mae</span><span class="kw">[[</span><span class="st">"cd45"</span>]]) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/transpose.html">t</a></span>() <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>()
<span class="no">x2</span> <span class="kw">&lt;-</span> <span class="fu">assay</span>(<span class="no">mae</span><span class="kw">[[</span><span class="st">"mibi"</span>]]) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/transpose.html">t</a></span>() <span class="kw">%&gt;%</span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>()
<span class="no">x</span> <span class="kw">&lt;-</span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join.html">full_join</a></span>(<span class="no">x1</span>, <span class="no">x2</span>)
<span class="no">markers</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x</span>)
<span class="no">cells</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x1</span>), <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x2</span>))
<span class="no">common_markers</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x1</span>)[<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x1</span>) <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x2</span>)]
<span class="no">common_markers</span>


<span class="co"># some features are not recorded in one domain - impute data after scaling</span>
<span class="no">colMissing</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">x</span>, <span class="fl">2</span>, <span class="kw">function</span>(<span class="no">y</span>){<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">y</span>))})

<span class="no">temp</span> <span class="kw">&lt;-</span> <span class="no">x</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.matrix</a></span>() <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/transpose.html">t</a></span>()</pre></body></html></div>
<div class="sourceCode" id="cb36"><html><body><pre class="r"><span class="no">imdata</span> <span class="kw">&lt;-</span> <span class="kw pkg">impute</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/impute/man/impute.knn.html">impute.knn</a></span>(<span class="no">temp</span>, <span class="kw">k</span><span class="kw">=</span><span class="fl">5</span>, <span class="kw">rowmax</span> <span class="kw">=</span> <span class="fl">0.5</span>, <span class="kw">colmax</span> <span class="kw">=</span> <span class="fl">0.9</span>)$<span class="no">data</span> <span class="co"># temp is variables in the rows and samples in the columns</span>
<span class="co"># x[is.na(x)] &lt;- 0</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="no">imdata</span>, <span class="st">"imdata_mibi_cytof_one.rds"</span>)</pre></body></html></div>
<div class="sourceCode" id="cb37"><html><body><pre class="r"><span class="no">imdata</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"imdata_mibi_cytof_one.rds"</span>)
<span class="no">x</span> <span class="kw">&lt;-</span> <span class="no">imdata</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/transpose.html">t</a></span>()
<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x</span>) <span class="kw">&lt;-</span> <span class="no">cells</span></pre></body></html></div>
</div>
<div id="topic-modeling" class="section level1">
<h1 class="hasAnchor">
<a href="#topic-modeling" class="anchor"></a>Topic modeling</h1>
<p>Consider test cells</p>
<div class="sourceCode" id="cb38"><html><body><pre class="r"><span class="no">test_samples</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span>(<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x2</span>), <span class="kw">size</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x2</span>))*<span class="fl">0.1</span>, <span class="kw">digits</span> <span class="kw">=</span> <span class="fl">0</span>))
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="no">test_samples</span>, <span class="kw">file</span> <span class="kw">=</span> <span class="st">"test_samples_one_mibi_one_cytof.rds"</span>)</pre></body></html></div>
<div class="sourceCode" id="cb39"><html><body><pre class="r"><span class="no">test_samples</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"test_samples_one_mibi_one_cytof.rds"</span>)
<span class="no">x_test_train</span> <span class="kw">&lt;-</span> <span class="no">x</span>
<span class="no">x_test</span> <span class="kw">&lt;-</span> <span class="no">x</span>[<span class="no">test_samples</span>, ]
<span class="no">x_test</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">x_test</span> , <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">2</span>), <span class="kw">function</span>(<span class="no">y</span>){<span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="no">y</span>)})
<span class="no">x_test</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.matrix</a></span>(<span class="no">x_test</span>)
<span class="no">mae_test</span> <span class="kw">&lt;-</span> <span class="no">mae</span>[, <span class="no">test_samples</span>,]

<span class="no">x_train</span> <span class="kw">&lt;-</span> <span class="no">x</span>[!(<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x</span>) <span class="kw">%in%</span> <span class="no">test_samples</span>), ]
<span class="no">x_train</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">x_train</span> , <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">2</span>), <span class="kw">function</span>(<span class="no">y</span>){<span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="no">y</span>)})
<span class="no">x_train</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.matrix</a></span>(<span class="no">x_train</span>)
<span class="no">mae_train</span> <span class="kw">&lt;-</span> <span class="no">mae</span>[, <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(!(<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x</span>) <span class="kw">%in%</span> <span class="no">test_samples</span>)),]</pre></body></html></div>
<div class="sourceCode" id="cb40"><html><body><pre class="r"><span class="co"># theta[d] ~ dirichlet(alpha), alpha pseudocount for each topic</span>
<span class="co"># beta[k] ~ dirichlet(gamma), gamma pseudocount for each ASV in each topic</span>
<span class="no">stan.data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">K</span> <span class="kw">=</span> <span class="no">K</span>,
  <span class="kw">V</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">ncol</a></span>(<span class="no">x_train</span>),
  <span class="kw">D</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span>(<span class="no">x_train</span>),
  <span class="kw">n</span> <span class="kw">=</span> <span class="no">x_train</span>,
  <span class="kw">alpha</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">.8</span>, <span class="no">K</span>),
  <span class="kw">gamma</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">.5</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">ncol</a></span>(<span class="no">x_train</span>))
)</pre></body></html></div>
<div class="sourceCode" id="cb41"><html><body><pre class="r"><span class="no">fileN</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"LDA_mibi_cytof_one_K_"</span>,<span class="no">K</span>,<span class="st">"_ite_"</span>,<span class="no">iter</span>,<span class="st">".RData"</span>)
<span class="no">fileN</span></pre></body></html></div>
<div class="sourceCode" id="cb42"><html><body><pre class="r"><span class="no">t1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>()
<span class="no">stan.fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rstan/man/stan.html">stan</a></span>(<span class="kw">file</span> <span class="kw">=</span> <span class="st">"./lda.stan"</span>,
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">stan.data</span>,
  <span class="kw">iter</span> <span class="kw">=</span> <span class="no">iter</span>,
  <span class="kw">chains</span> <span class="kw">=</span> <span class="fl">4</span>,
  <span class="kw">sample_file</span> <span class="kw">=</span> <span class="kw">NULL</span>,
  <span class="kw">diagnostic_file</span> <span class="kw">=</span> <span class="kw">NULL</span>,
  <span class="kw">cores</span> <span class="kw">=</span> <span class="fl">4</span>,
  <span class="kw">control</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">adapt_delta</span> <span class="kw">=</span> <span class="fl">0.9</span>),
  <span class="kw">save_dso</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
  <span class="kw">algorithm</span> <span class="kw">=</span> <span class="st">"NUTS"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/proc.time.html">proc.time</a></span>() - <span class="no">t1</span>

<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span>(<span class="no">stan.fit</span>, <span class="kw">file</span> <span class="kw">=</span> <span class="no">fileN</span>)</pre></body></html></div>
<div class="sourceCode" id="cb43"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="kw">file</span> <span class="kw">=</span> <span class="no">fileN</span>)</pre></body></html></div>
<p>Sampler diagnostics</p>
<div class="sourceCode" id="cb44"><html><body><pre class="r"><span class="no">sampler_params</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rstan/man/stanfit-class.html">get_sampler_params</a></span>(<span class="no">stan.fit</span>,
                                     <span class="kw">inc_warmup</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">sampler_params</span><span class="kw">[[</span><span class="fl">1</span>]])

<span class="no">mean_accept_stat_by_chain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">sampler_params</span>,
                                    <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">x</span>[, <span class="st">"accept_stat__"</span>]))
<span class="no">mean_accept_stat_by_chain</span>

<span class="no">max_treedepth_by_chain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">sampler_params</span>,
                                 <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">x</span>[, <span class="st">"treedepth__"</span>]))
<span class="no">max_treedepth_by_chain</span></pre></body></html></div>
</div>
<div id="visualization" class="section level1">
<h1 class="hasAnchor">
<a href="#visualization" class="anchor"></a>Visualization</h1>
<div id="extract-posterior-samples" class="section level2">
<h2 class="hasAnchor">
<a href="#extract-posterior-samples" class="anchor"></a>Extract posterior samples</h2>
<div class="sourceCode" id="cb45"><html><body><pre class="r"><span class="no">samples</span> <span class="kw">&lt;-</span> <span class="kw pkg">rstan</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/rstan/man/stanfit-method-extract.html">extract</a></span>(<span class="no">stan.fit</span>,
                          <span class="kw">permuted</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                          <span class="kw">inc_warmup</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
                          <span class="kw">include</span> <span class="kw">=</span> <span class="fl">TRUE</span>)<span class="co"># samples is a list</span></pre></body></html></div>
</div>
<div id="alignment" class="section level2">
<h2 class="hasAnchor">
<a href="#alignment" class="anchor"></a>Alignment</h2>
<ul>
<li>Create a Topic <span class="math inline">\(*\)</span> Chain matrix</li>
</ul>
<div class="sourceCode" id="cb46"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"../R/alignmentMatrixMAE.R"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"../R/thetaAligned.R"</span>)
<span class="no">theta</span> <span class="kw">&lt;-</span> <span class="no">samples</span>$<span class="no">theta</span>
<span class="no">aligned</span> <span class="kw">&lt;-</span> <span class="fu">alignmentMatrixMAE</span>(<span class="no">theta</span>,
                           <span class="no">mae_train</span>,
                           <span class="no">K</span>,
                           <span class="kw">iter</span> <span class="kw">=</span> <span class="no">iter</span>,
                           <span class="kw">chain</span> <span class="kw">=</span> <span class="fl">4</span>,
                           <span class="kw">SampleID_name</span> <span class="kw">=</span> <span class="st">"cell_id"</span>)
<span class="no">theta_aligned</span> <span class="kw">&lt;-</span> <span class="fu">thetaAligned</span>(<span class="no">theta</span>,
                              <span class="no">K</span>,
                              <span class="no">aligned</span>,
                              <span class="kw">iter</span> <span class="kw">=</span> <span class="no">iter</span>,
                              <span class="kw">chain</span> <span class="kw">=</span> <span class="fl">4</span>)
<span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span>(<span class="no">theta_aligned</span>)<span class="kw">[[</span><span class="fl">2</span>]] <span class="kw">&lt;-</span> <span class="no">mae_train</span>$<span class="no">cell_id</span>
<span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span>(<span class="no">theta_aligned</span>)<span class="kw">[[</span><span class="fl">3</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Topic_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>,<span class="no">K</span>)))

<span class="co"># array to a dataframe</span>
<span class="no">theta_all</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="no">theta_aligned</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">theta_all</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"iteration"</span>, <span class="st">"Sample"</span>, <span class="st">"Topic"</span>, <span class="st">"topic.dis"</span>)
<span class="no">theta_all</span>$<span class="no">Chain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Chain "</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fl">4</span>), <span class="kw">each</span> <span class="kw">=</span> (<span class="no">iter</span>/<span class="fl">2</span>)))

<span class="no">sam</span> <span class="kw">&lt;-</span> <span class="fu">colData</span>(<span class="no">mae_train</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>()
<span class="no">theta_all</span>$<span class="no">Sample</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.character.html">as.character</a></span>(<span class="no">theta_all</span>$<span class="no">Sample</span>)
<span class="no">theta_all</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(<span class="no">theta_all</span>, <span class="no">sam</span>, <span class="kw">by</span> <span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Sample"</span><span class="kw">=</span> <span class="st">"cell_id"</span>))
<span class="no">theta_all</span>$<span class="no">Chain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">theta_all</span>$<span class="no">Chain</span>)
<span class="no">theta_all</span>$<span class="no">Topic</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">theta_all</span>$<span class="no">Topic</span>)
<span class="no">theta_all</span>$<span class="no">Sample</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">theta_all</span>$<span class="no">Sample</span>)

<span class="no">theta_all</span>$<span class="no">cell_type</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">theta_all</span>$<span class="no">cell_type</span>)
<span class="no">theta_all</span>$<span class="no">method</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">theta_all</span>$<span class="no">cell_type</span>), <span class="st">"cytof"</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.character.html">as.character</a></span>(<span class="no">theta_all</span>$<span class="no">cell_type</span>))</pre></body></html></div>
<div class="sourceCode" id="cb47"><html><body><pre class="r"><span class="no">manual_col</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggthemes/man/tableau_color_pal.html">tableau_color_pal</a></span>(<span class="st">"Classic 20"</span>)(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html">unique</a></span>(<span class="no">theta_all</span>$<span class="no">method</span>)))

<span class="no">theta_summary</span> <span class="kw">&lt;-</span> <span class="no">theta_all</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">Sample</span>, <span class="no">Topic</span>, <span class="no">method</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/summarise.html">summarize</a></span>(<span class="kw">median.topic.dis</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span>(<span class="no">topic.dis</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mutate.html">mutate</a></span>(<span class="kw">Topic</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">Topic</span>, <span class="kw">levels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span>(<span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span>(<span class="st">"Topic_"</span>,<span class="fl">1</span>:<span class="no">K</span>))))

<span class="co">#theta_summary &lt;- dplyr::filter(theta_summary, cell_type %in% c("Macrophages", "Tumor"))</span>

<span class="no">sample_cells</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html">unique</a></span>(<span class="no">theta_summary</span>$<span class="no">Sample</span>)
<span class="no">sample_cells_select</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample.html">sample</a></span>(<span class="no">sample_cells</span>, <span class="fl">100</span>)

<span class="no">theta_summary</span> <span class="kw">&lt;-</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">theta_summary</span>,
                               <span class="no">Sample</span> <span class="kw">%in%</span> <span class="no">sample_cells_select</span>)

<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">theta_summary</span>,
           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">method</span>,
               <span class="kw">y</span> <span class="kw">=</span> <span class="no">Topic</span>,
               <span class="kw">fill</span> <span class="kw">=</span> <span class="no">method</span>))
<span class="no">p</span> <span class="kw">&lt;-</span> <span class="no">p</span>+
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="no">median.topic.dis</span>))+
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(<span class="no">.</span>~<span class="no">Sample</span>, <span class="kw">scale</span> <span class="kw">=</span> <span class="st">"free"</span>)+
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"method"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="st">"method"</span>,
                    <span class="kw">values</span> <span class="kw">=</span> <span class="no">manual_col</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_alpha.html">scale_alpha</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="st">"median topic distribution"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">20</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">plot.title</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0.5</span>),
        <span class="kw">strip.text.x</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">90</span>),
        <span class="kw">axis.text.x</span><span class="kw">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>())
<span class="no">p</span>

<span class="co"># ggsave(paste0("topic_dis_mibi_cytof_one_K_",K, ".png"), p, width = 20, height = 6)</span></pre></body></html></div>
</div>
<div id="marker-distribution" class="section level2">
<h2 class="hasAnchor">
<a href="#marker-distribution" class="anchor"></a>Marker distribution</h2>
<div class="sourceCode" id="cb48"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"../R/betaAligned.R"</span>)
<span class="no">beta</span> <span class="kw">&lt;-</span> <span class="no">samples</span>$<span class="no">beta</span> <span class="co"># an array (iterations *topic * marker)</span>
<span class="no">beta_aligned</span> <span class="kw">&lt;-</span> <span class="fu">betaAligned</span>(<span class="no">beta</span>,
                            <span class="no">K</span>,
                            <span class="no">aligned</span>,
                            <span class="kw">iter</span> <span class="kw">=</span> <span class="no">iter</span>,
                            <span class="kw">chain</span> <span class="kw">=</span> <span class="fl">4</span>) <span class="co"># an array (iterations *topic * ASV)</span>

<span class="co"># array to data frame</span>
<span class="no">beta_hat</span> <span class="kw">&lt;-</span> <span class="no">beta_aligned</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="kw">varnames</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"iterations"</span>, <span class="st">"topic"</span>, <span class="st">"marker_ix"</span>),
       <span class="kw">value.name</span> <span class="kw">=</span> <span class="st">"beta_h"</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reexports.html">as_tibble</a></span>()
<span class="no">beta_hat</span>$<span class="no">marker</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x_train</span>)[<span class="no">beta_hat</span>$<span class="no">marker_ix</span>]


<span class="co"># join rowData with beta_hat</span>
<span class="no">marker_info</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join.html">full_join</a></span>(<span class="fu">rowData</span>(<span class="no">mae_train</span><span class="kw">[[</span><span class="st">"cd45"</span>]]) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(), <span class="fu">rowData</span>(<span class="no">mae_train</span><span class="kw">[[</span><span class="st">"mibi"</span>]]) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>())
<span class="no">marker_info</span>$<span class="no">marker</span> <span class="kw">&lt;-</span> <span class="no">marker_info</span>$<span class="no">marker_name</span>


<span class="no">beta_hat</span> <span class="kw">&lt;-</span> <span class="no">beta_hat</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(<span class="no">marker_info</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"marker"</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mutate.html">mutate</a></span>(<span class="kw">topic</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Topic"</span>, <span class="no">topic</span>))


<span class="no">beta_hat</span>$<span class="no">marker</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">beta_hat</span>$<span class="no">marker</span>)
<span class="no">beta_hat</span>$<span class="no">marker_ix</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">beta_hat</span>$<span class="no">marker_ix</span>)
<span class="no">beta_hat</span>$<span class="no">topic</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">beta_hat</span>$<span class="no">topic</span>)


<span class="no">beta_summary</span> <span class="kw">&lt;-</span> <span class="no">beta_hat</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">marker_ix</span>, <span class="no">topic</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(
    <span class="kw">marker</span> <span class="kw">=</span> <span class="no">marker</span>[<span class="fl">1</span>],
    <span class="kw">beta_median</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span>(<span class="no">beta_h</span>),
    <span class="kw">marker</span> <span class="kw">=</span> <span class="no">marker</span>[<span class="fl">1</span>],
    <span class="kw">hgnc_symbol</span> <span class="kw">=</span> <span class="no">hgnc_symbol</span>[<span class="fl">1</span>]
  )

<span class="no">beta_subset</span> <span class="kw">&lt;-</span> <span class="no">beta_summary</span>
<span class="no">beta_subset</span>$<span class="no">marker_ix</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span>(<span class="no">beta_subset</span>) / <span class="no">K</span>), <span class="kw">each</span> <span class="kw">=</span> <span class="no">K</span>)</pre></body></html></div>
<div class="sourceCode" id="cb49"><html><body><pre class="r"><span class="no">beta_subset</span> <span class="kw">&lt;-</span> <span class="no">beta_subset</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/arrange.html">arrange</a></span>(<span class="no">marker_ix</span>, <span class="no">topic</span>)

<span class="no">beta_subset</span> <span class="kw">&lt;-</span> <span class="no">beta_subset</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mutate.html">mutate</a></span>(<span class="kw">Class</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">marker</span>, <span class="kw">levels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html">unique</a></span>(<span class="no">beta_subset</span>$<span class="no">marker</span>)),
         <span class="kw">Topic</span> <span class="kw">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove</a></span>(<span class="no">topic</span>, <span class="st">"Topic "</span>))


<span class="no">beta_subset</span>$<span class="no">Topic</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">beta_subset</span>$<span class="no">Topic</span>, <span class="kw">levels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>,<span class="no">K</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.character.html">as.character</a></span>())

<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="no">beta_subset</span>,
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">Topic</span>,
                <span class="kw">y</span> <span class="kw">=</span> <span class="no">marker</span>,
                <span class="kw">fill</span> <span class="kw">=</span> <span class="no">beta_median</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Marker"</span>)+
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradientn</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="st">"Median ASV distribution"</span>,
                       <span class="kw">colours</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"gray98"</span>, <span class="st">"dodgerblue"</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">20</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">plot.title</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0.5</span>))

<span class="no">p</span>
<span class="co"># ggsave(paste0("asv_dist_barplot_mibi_cytof_one_K_",K, ".png"), p, width = 13, height = 11)</span></pre></body></html></div>
</div>
</div>
<div id="computing-statistics-after-alignment" class="section level1">
<h1 class="hasAnchor">
<a href="#computing-statistics-after-alignment" class="anchor"></a>Computing statistics after alignment</h1>
<p>Here we use all 2000 iterations</p>
</div>
<div id="log-posterior-on-the-test-data" class="section level1">
<h1 class="hasAnchor">
<a href="#log-posterior-on-the-test-data" class="anchor"></a>Log posterior on the test data</h1>
<div class="sourceCode" id="cb50"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span>(<span class="no">x_test</span>) <span class="kw">=</span> <span class="kw">NULL</span>
<span class="no">test_data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">K</span> <span class="kw">=</span> <span class="no">K</span>,
  <span class="kw">V</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">ncol</a></span>(<span class="no">x_test</span>),
  <span class="kw">D</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span>(<span class="no">x_test</span>),
  <span class="kw">n</span> <span class="kw">=</span> <span class="no">x_test</span>,
  <span class="kw">alpha</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">.8</span>, <span class="no">K</span>),
  <span class="kw">gamma</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">.5</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">ncol</a></span>(<span class="no">x_test</span>))
)

<span class="no">log_lik_total_for_each_iteration</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>()
<span class="kw">for</span>(<span class="no">it</span> <span class="kw">in</span> <span class="fl">1</span>:((<span class="no">iter</span>/<span class="fl">2</span>)*<span class="fl">4</span>)){
  <span class="no">log_lik</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>()
    <span class="kw">for</span>(<span class="no">j</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">x_test</span>)[<span class="fl">1</span>]){<span class="co"># For each sample j in the test set</span>
      <span class="no">theta_aligned_sim</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gtools/man/dirichlet.html">rdirichlet</a></span>(<span class="fl">1</span>, <span class="no">test_data</span>$<span class="no">alpha</span>)<span class="co"># simulate topic distribution from prior distribution</span>
      <span class="no">p_vec_pos</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.matrix</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/transpose.html">t</a></span>(<span class="no">beta_aligned</span>[<span class="no">it</span>, , ])) <span class="kw">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="no">theta_aligned_sim</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="no">K</span>, <span class="kw">byrow</span> <span class="kw">=</span> <span class="no">T</span>)

      <span class="no">log_lik</span>[<span class="no">j</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Multinom.html">dmultinom</a></span>(<span class="no">x_test</span>[<span class="no">j</span>, ], <span class="kw">size</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">x_test</span>[<span class="no">j</span>, ]), <span class="kw">prob</span> <span class="kw">=</span> <span class="no">p_vec_pos</span>, <span class="kw">log</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
    }
  <span class="no">log_lik_total_for_each_iteration</span>[<span class="no">it</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">log_lik</span>)
}


<span class="no">df_lp_corrected</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">lp</span> <span class="kw">=</span> <span class="no">log_lik_total_for_each_iteration</span>,
                             <span class="kw">Chain</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Chain "</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="fl">4</span>), <span class="kw">each</span> <span class="kw">=</span> (<span class="no">iter</span>/<span class="fl">2</span>))))

<span class="no">fileN</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"df_lp_test_mibi_cytof_one_K_"</span>, <span class="no">K</span>, <span class="st">".rds"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="no">df_lp_corrected</span>, <span class="no">fileN</span>)</pre></body></html></div>
<div class="sourceCode" id="cb51"><html><body><pre class="r"><span class="no">df_lp_corrected_all_K</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>()
<span class="kw">for</span>(<span class="no">top</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>:<span class="fl">5</span>, <span class="fl">15</span>,<span class="fl">20</span>)){
  <span class="no">fileN</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"df_lp_test_mibi_cytof_one_K_"</span>, <span class="no">top</span>, <span class="st">".rds"</span>)
  <span class="no">df_lp_corrected</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="no">fileN</span>)
  <span class="no">df_lp_corrected</span>$<span class="no">Num_Topic</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"T="</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="no">top</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">df_lp_corrected</span>)[<span class="fl">1</span>]))
  <span class="no">df_lp_corrected_all_K</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="no">df_lp_corrected_all_K</span>, <span class="no">df_lp_corrected</span>)
}

<span class="no">df_lp_corrected_all_K</span>$<span class="no">Num_Topic</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">df_lp_corrected_all_K</span>$<span class="no">Num_Topic</span>, <span class="kw">levels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"T="</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">3</span>, <span class="fl">5</span>), <span class="fl">15</span>, <span class="fl">20</span>))
))

<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">df_lp_corrected_all_K</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">Num_Topic</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">lp</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Predictive log-likelihood in test data"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"Number of topics"</span>)

<span class="no">p</span>
<span class="co"># ggsave("lp_test_mibi_cytof_one.png", p, width = 7, height = 4)</span></pre></body></html></div>
</div>
<div id="convergence-diagnostics" class="section level1">
<h1 class="hasAnchor">
<a href="#convergence-diagnostics" class="anchor"></a>Convergence diagnostics</h1>
<p>Compute <span class="math inline">\(\hat{R}\)</span></p>
<p>These <span class="math inline">\(\hat{R}\)</span> based on 100 iterations</p>
<div class="sourceCode" id="cb52"><html><body><pre class="r"><span class="no">Rhat_theta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="kw">nrow</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">theta_aligned</span>)[<span class="fl">2</span>], <span class="kw">ncol</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">theta_aligned</span>)[<span class="fl">3</span>])
<span class="no">ESS_bulk_theta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="kw">nrow</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">theta_aligned</span>)[<span class="fl">2</span>], <span class="kw">ncol</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">theta_aligned</span>)[<span class="fl">3</span>])
<span class="no">ESS_tail_theta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="kw">nrow</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">theta_aligned</span>)[<span class="fl">2</span>], <span class="kw">ncol</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">theta_aligned</span>)[<span class="fl">3</span>])
<span class="kw">for</span>(<span class="no">sam</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">theta_aligned</span>)[<span class="fl">2</span>]){
  <span class="kw">for</span>(<span class="no">top</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">theta_aligned</span>)[<span class="fl">3</span>]){
    <span class="no">sims_theta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="no">theta_aligned</span>[ ,<span class="no">sam</span> , <span class="no">top</span>], <span class="kw">nrow</span> <span class="kw">=</span> (<span class="no">iter</span>/<span class="fl">2</span>), <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">4</span>, <span class="kw">byrow</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
    <span class="no">Rhat_theta</span>[<span class="no">sam</span>, <span class="no">top</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rstan/man/Rhat.html">Rhat</a></span>(<span class="no">sims_theta</span>)
    <span class="no">ESS_bulk_theta</span>[<span class="no">sam</span>, <span class="no">top</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rstan/man/Rhat.html">ess_bulk</a></span>(<span class="no">sims_theta</span>)
    <span class="no">ESS_tail_theta</span>[<span class="no">sam</span>, <span class="no">top</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rstan/man/Rhat.html">ess_tail</a></span>(<span class="no">sims_theta</span>)
  }

}

<span class="no">Rhat_theta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span>(<span class="no">Rhat_theta</span>)
<span class="no">ESS_bulk_theta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span>(<span class="no">ESS_bulk_theta</span>)
<span class="no">ESS_tail_theta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span>(<span class="no">ESS_tail_theta</span>)

<span class="no">Rhat_beta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="kw">nrow</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">beta_aligned</span>)[<span class="fl">2</span>], <span class="kw">ncol</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">beta_aligned</span>)[<span class="fl">3</span>])
<span class="no">ESS_bulk_beta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="kw">nrow</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">beta_aligned</span>)[<span class="fl">2</span>], <span class="kw">ncol</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">beta_aligned</span>)[<span class="fl">3</span>])
<span class="no">ESS_tail_beta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="kw">nrow</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">beta_aligned</span>)[<span class="fl">2</span>], <span class="kw">ncol</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">beta_aligned</span>)[<span class="fl">3</span>])

<span class="kw">for</span>(<span class="no">top</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">beta_aligned</span>)[<span class="fl">2</span>]){
    <span class="kw">for</span>(<span class="no">fea</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">beta_aligned</span>)[<span class="fl">3</span>]){
      <span class="no">sims_beta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="no">beta_aligned</span>[ , <span class="no">top</span>, <span class="no">fea</span>], <span class="kw">nrow</span> <span class="kw">=</span> (<span class="no">iter</span>/<span class="fl">2</span>), <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">4</span>, <span class="kw">byrow</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
      <span class="no">Rhat_beta</span>[<span class="no">top</span>, <span class="no">fea</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rstan/man/Rhat.html">Rhat</a></span>(<span class="no">sims_beta</span>)
      <span class="no">ESS_bulk_beta</span>[<span class="no">top</span>, <span class="no">fea</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rstan/man/Rhat.html">ess_bulk</a></span>(<span class="no">sims_beta</span>)
      <span class="no">ESS_tail_beta</span>[<span class="no">top</span>, <span class="no">fea</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rstan/man/Rhat.html">ess_tail</a></span>(<span class="no">sims_beta</span>)
    }

}

<span class="no">Rhat_beta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span>(<span class="no">Rhat_beta</span>)
<span class="no">ESS_bulk_beta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span>(<span class="no">ESS_bulk_beta</span>)
<span class="no">ESS_tail_beta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span>(<span class="no">ESS_tail_beta</span>)

<span class="no">Rhat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">Rhat_theta</span>, <span class="no">Rhat_beta</span>)
<span class="co"># fileN &lt;- paste0("Rhat_mibi_cytof_one_K_",K, ".rds")</span>
<span class="co"># saveRDS(Rhat, fileN)</span>

<span class="no">ESS_bulk</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">ESS_bulk_theta</span>, <span class="no">ESS_bulk_beta</span>)
<span class="co"># fileN &lt;- paste0("ESS_bulk_mibi_cytof_one_K_",K, ".rds")</span>
<span class="co"># saveRDS(ESS_bulk, fileN)</span>

<span class="no">ESS_tail</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">ESS_tail_theta</span>, <span class="no">ESS_tail_beta</span>)
<span class="co"># fileN &lt;- paste0("ESS_tail_mibi_cytof_one_K_",K, ".rds")</span>
<span class="co"># saveRDS(ESS_tail, fileN)</span>

<span class="co"># R hat ~ 1.05</span>
<span class="no">p_rhat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">Rhat</span> <span class="kw">=</span> <span class="no">Rhat</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">Rhat</span>),
                 <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"lavender"</span>,
                 <span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>,
                 <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">100</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">20</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">plot.title</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0.5</span>))  +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">20</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>)
<span class="no">p_rhat</span>


<span class="co"># ggsave(paste0("/Rhat_mibi_cytof_one_K_",K, ".png"), p_rhat, width = 9, height = 6)</span></pre></body></html></div>
<p>Compute ESS</p>
<div class="sourceCode" id="cb53"><html><body><pre class="r"><span class="co"># ESS bulk and ESS tail at least 100 per Markov Chain in order to be reliable and indicate that estimates of respective posterior quantiles are reliable</span>

<span class="no">p_ess_bulk</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">ESS_bulk</span> <span class="kw">=</span> <span class="no">ESS_bulk</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">ESS_bulk</span>),
                 <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"lavender"</span>,
                 <span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>,
                 <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">100</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">20</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">plot.title</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0.5</span>))   +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">20</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>)


<span class="no">p_ess_bulk</span>

<span class="co"># ggsave(paste0("ess_bulk_mibi_cytof_one_K_",K, ".png"), p_ess_bulk, width = 9, height = 6)</span>

<span class="no">p_ess_tail</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">ESS_tail</span> <span class="kw">=</span> <span class="no">ESS_tail</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">ESS_tail</span>),
                 <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"lavender"</span>,
                 <span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>,
                 <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">100</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span>(<span class="kw">base_size</span> <span class="kw">=</span> <span class="fl">20</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">plot.title</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0.5</span>))

<span class="no">p_ess_tail</span>
<span class="co"># ggsave(paste0("ess_tail_mibi_cytof_one_K_",K, ".png"), p_ess_tail, width = 9, height = 6)</span></pre></body></html></div>
</div>
<div id="model-assesment-on-simulated-data" class="section level1">
<h1 class="hasAnchor">
<a href="#model-assesment-on-simulated-data" class="anchor"></a>Model assesment on simulated data</h1>
<div class="sourceCode" id="cb54"><html><body><pre class="r"><span class="co"># Simulated data</span>
<span class="no">x_sim</span> <span class="kw">&lt;-</span> <span class="no">samples</span>$<span class="no">x_sim</span> <span class="co"># iteration * samples * ASVs</span>
<span class="co"># Choose only the first chain</span>
<span class="no">x_sim</span> <span class="kw">&lt;-</span> <span class="no">x_sim</span>[<span class="fl">1</span>:(<span class="no">iter</span>/<span class="fl">2</span>), ,] <span class="co"># For each iteration, simulated data is x_sim[i, ,]</span>
<span class="no">x_med_asv</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">x</span> <span class="kw">%&gt;%</span> <span class="no">data.frame</span> , <span class="fl">2</span>, <span class="no">median</span>)
<span class="no">sim_ite</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">x_sim</span>)[<span class="fl">1</span>]
<span class="no">ite_plot</span> <span class="kw">&lt;-</span> <span class="fl">19</span><span class="co"># or ite_plot &lt;- sim_ite</span>
<span class="co">#Find maximum of each asv for each iteration</span>
<span class="no">med_all</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">x_med_asv</span> <span class="kw">=</span> <span class="no">x_med_asv</span>)
<span class="kw">for</span>(<span class="no">i</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="no">ite_plot</span>){
  <span class="no">x_sim_i</span> <span class="kw">&lt;-</span> <span class="no">x_sim</span>[<span class="no">i</span>, ,]
  <span class="no">med_x_sim_i</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">x_sim_i</span> <span class="kw">%&gt;%</span> <span class="no">data.frame</span> , <span class="fl">2</span>, <span class="no">median</span>)
  <span class="no">med_all</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">med_all</span>, <span class="no">med_x_sim_i</span>)
}

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">med_all</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"x_med_asv"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"x_med_sim_1"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="no">ite_plot</span>)))
<span class="no">avg_med_square</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span>()

<span class="co"># histogram of maximum</span>
<span class="no">med_all_long</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="no">med_all</span>)
<span class="no">med_all_long</span>$<span class="no">type</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"observed"</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">x_sim</span>)[<span class="fl">3</span>]), <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"simulated"</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">x_sim</span>)[<span class="fl">3</span>]*(<span class="no">ite_plot</span>)))
<span class="no">med_all_long</span>$<span class="no">type</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">med_all_long</span>$<span class="no">type</span>)
<span class="no">p_hist_obs_sim</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">med_all_long</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">value</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">variable</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">type</span>),
                 <span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>,
                 <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">100</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(~<span class="no">variable</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">5</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>)

<span class="no">p_hist_obs_sim</span>
<span class="co"># ggsave(paste0("model_assesment_hist_obs_sim_mibi_cytof_one_K_",K, ".png"), p_hist_obs_sim, width = 12, height = 6)</span></pre></body></html></div>
<p>The distribution of observed median of each protein expression (first facet) is similar to median of simulated data from the fitted topic model (other facets).</p>
</div>
<div id="infer-spatial-location-of-cytof-immune-cells" class="section level1">
<h1 class="hasAnchor">
<a href="#infer-spatial-location-of-cytof-immune-cells" class="anchor"></a>Infer spatial location of cytof immune cells</h1>
<p>We use the sample from the first chain</p>
<ul>
<li>Create a Topic <span class="math inline">\(*\)</span> Chain matrix</li>
</ul>
<div class="sourceCode" id="cb55"><html><body><pre class="r"><span class="no">theta</span> <span class="kw">&lt;-</span> <span class="no">samples</span>$<span class="no">theta</span>
<span class="no">theta_aligned</span> <span class="kw">&lt;-</span> <span class="no">theta</span>[<span class="fl">1</span>:(<span class="no">iter</span>/<span class="fl">2</span>), ,]
<span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span>(<span class="no">theta_aligned</span>)<span class="kw">[[</span><span class="fl">2</span>]] <span class="kw">&lt;-</span> <span class="no">mae_train</span>$<span class="no">cell_id</span>
<span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span>(<span class="no">theta_aligned</span>)<span class="kw">[[</span><span class="fl">3</span>]] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Topic_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>,<span class="no">K</span>)))

<span class="co"># array to a dataframe</span>
<span class="no">theta_all</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="no">theta_aligned</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">theta_all</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"iteration"</span>, <span class="st">"Sample"</span>, <span class="st">"Topic"</span>, <span class="st">"topic.dis"</span>)
<span class="no">theta_all</span>$<span class="no">Chain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"Chain "</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fl">1</span>), <span class="kw">each</span> <span class="kw">=</span> (<span class="no">iter</span>/<span class="fl">2</span>)))

<span class="no">sam</span> <span class="kw">&lt;-</span> <span class="fu">colData</span>(<span class="no">mae_train</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>()
<span class="no">theta_all</span>$<span class="no">Sample</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.character.html">as.character</a></span>(<span class="no">theta_all</span>$<span class="no">Sample</span>)
<span class="no">theta_all</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(<span class="no">theta_all</span>, <span class="no">sam</span>, <span class="kw">by</span> <span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Sample"</span><span class="kw">=</span> <span class="st">"cell_id"</span>))
<span class="no">theta_all</span>$<span class="no">Chain</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">theta_all</span>$<span class="no">Chain</span>)
<span class="no">theta_all</span>$<span class="no">Topic</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">theta_all</span>$<span class="no">Topic</span>)
<span class="no">theta_all</span>$<span class="no">Sample</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">theta_all</span>$<span class="no">Sample</span>)

<span class="no">theta_all</span>$<span class="no">cell_type</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">theta_all</span>$<span class="no">cell_type</span>)
<span class="no">theta_all</span>$<span class="no">method</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">theta_all</span>$<span class="no">cell_type</span>), <span class="st">"cytof"</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.character.html">as.character</a></span>(<span class="no">theta_all</span>$<span class="no">cell_type</span>))</pre></body></html></div>
<p>Based on the median topic distribution identified the most dominated topic in each cell</p>
<div class="sourceCode" id="cb56"><html><body><pre class="r"><span class="no">theta_summary</span> <span class="kw">&lt;-</span> <span class="no">theta_all</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">Sample</span>, <span class="no">Topic</span>, <span class="no">method</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/summarise.html">summarize</a></span>(<span class="kw">median.topic.dis</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span>(<span class="no">topic.dis</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/plyr/man/mutate.html">mutate</a></span>(<span class="kw">Topic</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">Topic</span>, <span class="kw">levels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span>(<span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span>(<span class="st">"Topic_"</span>,<span class="fl">1</span>:<span class="no">K</span>))))

<span class="no">theta_summary_2</span> <span class="kw">&lt;-</span> <span class="no">theta_summary</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">Sample</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span>(
    <span class="kw">max_topic</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">median.topic.dis</span>),
    <span class="kw">Topic</span> <span class="kw">=</span> <span class="no">Topic</span>[<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">median.topic.dis</span> <span class="kw">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">median.topic.dis</span>))],
    <span class="kw">method</span> <span class="kw">=</span> <span class="no">method</span>[<span class="fl">1</span>]
  )

<span class="co"># saveRDS(theta_summary_2, paste0("../Results/co_location_mibi_cytof_one_K_", K, ".rds"))</span></pre></body></html></div>
<div class="sourceCode" id="cb57"><html><body><pre class="r"><span class="no">theta_summary_2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"co_location_mibi_cytof_one_K_"</span>, <span class="no">K</span>, <span class="st">".rds"</span>))</pre></body></html></div>
<p>MIBI has only one site so we may not be able to infer spatial location for some cells in CyTOF.</p>
<div class="sourceCode" id="cb58"><html><body><pre class="r"><span class="co"># mibi X, Y coordinates</span>
<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">Sample</span> <span class="kw">=</span> <span class="no">mae_train</span>$<span class="no">cell_id</span>, <span class="kw">X</span> <span class="kw">=</span> <span class="no">mae_train</span>$<span class="no">centroid_X</span>, <span class="kw">Y</span> <span class="kw">=</span> <span class="no">mae_train</span>$<span class="no">centroid_Y</span>)
<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(<span class="no">theta_summary_2</span>, <span class="no">df</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"Sample"</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>()
<span class="no">df</span>$<span class="no">Sample</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.character.html">as.character</a></span>(<span class="no">df</span>$<span class="no">Sample</span>)
<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">df</span>) <span class="kw">&lt;-</span> <span class="no">df</span>$<span class="no">Sample</span>
<span class="kw">for</span>(<span class="no">i</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span>(<span class="no">df</span>)[<span class="fl">1</span>]){
  <span class="kw">if</span>(<span class="no">df</span>$<span class="no">method</span>[<span class="no">i</span>] <span class="kw">==</span> <span class="st">"cytof"</span>){
    <span class="co">#subset the df mibi cells with the topic for ith cytof cell</span>
    <span class="no">df_i</span> <span class="kw">&lt;-</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">df</span>, <span class="no">Topic</span> <span class="kw">==</span> <span class="no">df</span>$<span class="no">Topic</span>[<span class="no">i</span>] <span class="kw">&amp;</span> <span class="no">method</span> <span class="kw">!=</span> <span class="st">"cytof"</span>)
    <span class="no">com_cell_close_to_max_topic_i</span> <span class="kw">&lt;-</span> <span class="no">df_i</span>$<span class="no">Sample</span>[<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="no">df</span>$<span class="no">max_topic</span>[<span class="no">i</span>] - <span class="no">df_i</span>$<span class="no">max_topic</span>) <span class="kw">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="no">df</span>$<span class="no">max_topic</span>[<span class="no">i</span>] - <span class="no">df_i</span>$<span class="no">max_topic</span>)))]
    <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">df</span>$<span class="no">Sample</span> <span class="kw">==</span> <span class="no">com_cell_close_to_max_topic_i</span>))<span class="kw">==</span><span class="fl">0</span>){
      <span class="no">df</span>$<span class="no">X</span>[<span class="no">i</span>] <span class="kw">&lt;-</span> <span class="fl">NA</span>
    }<span class="kw">else</span>{
      <span class="no">df</span>$<span class="no">X</span>[<span class="no">i</span>] <span class="kw">&lt;-</span> <span class="no">df</span>$<span class="no">X</span>[<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">df</span>$<span class="no">Sample</span> <span class="kw">==</span> <span class="no">com_cell_close_to_max_topic_i</span>)]
    }
    <span class="kw">if</span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">df</span>$<span class="no">Sample</span> <span class="kw">==</span> <span class="no">com_cell_close_to_max_topic_i</span>)) <span class="kw">==</span> <span class="fl">0</span>){
      <span class="no">df</span>$<span class="no">Y</span>[<span class="no">i</span>] <span class="kw">&lt;-</span> <span class="fl">NA</span>
    }<span class="kw">else</span>{
      <span class="no">df</span>$<span class="no">Y</span>[<span class="no">i</span>] <span class="kw">&lt;-</span> <span class="no">df</span>$<span class="no">Y</span>[<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">df</span>$<span class="no">Sample</span> <span class="kw">==</span> <span class="no">com_cell_close_to_max_topic_i</span>)]
    }

  }
}</pre></body></html></div>
<p>Plot the spatial location of cytof cells from patient BB028</p>
<div class="sourceCode" id="cb59"><html><body><pre class="r"><span class="no">manual_col</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggthemes/man/tableau_color_pal.html">tableau_color_pal</a></span>(<span class="st">"Classic 20"</span>)(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html">unique</a></span>(<span class="no">df</span>$<span class="no">method</span>)))
<span class="no">df</span>$<span class="no">method</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">df</span>$<span class="no">method</span>)
<span class="no">df_cytof</span> <span class="kw">&lt;-</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">df</span>, <span class="no">method</span> <span class="kw">==</span> <span class="st">"cytof"</span>)
<span class="no">p_co</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">df</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span><span class="kw">=</span> <span class="no">X</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Y</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">method</span>), <span class="kw">size</span> <span class="kw">=</span> <span class="fl">5</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(<span class="kw">values</span> <span class="kw">=</span> <span class="no">manual_col</span>)  +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">aspect.ratio</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"right"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">fill</span> <span class="kw">=</span> <span class="st">"method"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">df</span>$<span class="no">X</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">df</span>$<span class="no">Y</span>))) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">df_cytof</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">X</span>, <span class="kw">y</span><span class="kw">=</span> <span class="no">Y</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="no">Sample</span>), <span class="kw">check_overlap</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="no">p_co</span>

<span class="co"># ggsave(paste0("co_location_mibi_cytof_one_K_", K, ".png"), p_co, width = 15, height = 15)</span></pre></body></html></div>
</div>
<div id="predict-spatial-pattern-of-proteins-not-measured-in-the-mibi-tof" class="section level1">
<h1 class="hasAnchor">
<a href="#predict-spatial-pattern-of-proteins-not-measured-in-the-mibi-tof" class="anchor"></a>Predict spatial pattern of proteins not measured in the MIBI-TOF</h1>
<div class="sourceCode" id="cb60"><html><body><pre class="r"><span class="no">proteins_not_measured_mibi</span> <span class="kw">&lt;-</span> <span class="fu">rowData</span>(<span class="no">mae</span><span class="kw">[[</span><span class="st">"cd45"</span>]])$<span class="no">marker_name</span>[!(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.character.html">as.character</a></span>(<span class="fu">rowData</span>(<span class="no">mae</span><span class="kw">[[</span><span class="st">"cd45"</span>]])$<span class="no">marker_name</span>) <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.character.html">as.character</a></span>(<span class="fu">rowData</span>(<span class="no">mae</span><span class="kw">[[</span><span class="st">"mibi"</span>]])$<span class="no">channel_name</span>))] <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.character.html">as.character</a></span>()

<span class="co"># Simulated data</span>
<span class="no">x_sim</span> <span class="kw">&lt;-</span> <span class="no">samples</span>$<span class="no">x_sim</span> <span class="co"># iteration * samples * ASVs</span>
<span class="co"># Choose only the first chain</span>
<span class="no">x_sim</span> <span class="kw">&lt;-</span> <span class="no">x_sim</span>[<span class="fl">1</span>, ,] <span class="co"># For each iteration, simulated data </span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x_sim</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x_train</span>)
<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x_train</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x_train</span>)
<span class="no">ind_mibi</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x_train</span>) <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="fu">assay</span>(<span class="no">mae_train</span><span class="kw">[[</span><span class="st">"mibi"</span>]])))
<span class="no">x_sim_mibi</span> <span class="kw">&lt;-</span> <span class="no">x_sim</span>[<span class="no">ind_mibi</span>, ]
<span class="no">ind_pro</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x_train</span>) <span class="kw">%in%</span> <span class="no">proteins_not_measured_mibi</span>)
<span class="no">ind_pro_present</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(!(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x_train</span>) <span class="kw">%in%</span> <span class="no">proteins_not_measured_mibi</span>))

<span class="no">x_sim_mibi_only_measured</span> <span class="kw">&lt;-</span> <span class="no">x_train</span>[<span class="no">ind_mibi</span>, <span class="no">ind_pro_present</span>]
<span class="no">x_sim_mibi_only_measured_t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html">asinh</a></span>(<span class="no">x_sim_mibi_only_measured</span>)

<span class="no">x_sim_mibi_predict</span> <span class="kw">&lt;-</span> <span class="no">x_sim_mibi</span>
<span class="no">x_sim_mibi_predict_t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html">asinh</a></span>(<span class="no">x_sim_mibi_predict</span>)


<span class="co"># UMAP of measured proteins</span>
<span class="no">mibi_umap</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/uwot/man/umap.html">umap</a></span>(<span class="no">x_sim_mibi_only_measured_t</span>)
<span class="no">umap_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">UMAP1</span> <span class="kw">=</span> <span class="no">mibi_umap</span>[,<span class="fl">1</span>],
                      <span class="kw">UMAP2</span> <span class="kw">=</span> <span class="no">mibi_umap</span>[,<span class="fl">2</span>],
                      <span class="kw">cell_id</span> <span class="kw">=</span> <span class="fu">colData</span>(<span class="no">mae_train</span>)$<span class="no">cell_id</span>[<span class="no">ind_mibi</span>])
<span class="no">mibi_cell_data</span> <span class="kw">&lt;-</span> <span class="fu">colData</span>(<span class="no">mae_train</span>)[<span class="no">ind_mibi</span>, ] <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>()
<span class="no">umap_df</span>  <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(<span class="no">umap_df</span>, <span class="no">mibi_cell_data</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"cell_id"</span>)

<span class="no">manual_col</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggthemes/man/tableau_color_pal.html">tableau_color_pal</a></span>(<span class="st">"Classic 20"</span>)(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html">unique</a></span>(<span class="no">mae_train</span>$<span class="no">cell_type</span>)))

<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">umap_df</span>,
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">UMAP1</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">UMAP2</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">cell_type</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">3</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(<span class="kw">values</span> <span class="kw">=</span> <span class="no">manual_col</span>)  +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">color</span> <span class="kw">=</span> <span class="st">"Cell types"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"UMAP with measured proteins"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">aspect.ratio</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">plot.title</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0.5</span>))
<span class="no">p1</span></pre></body></html></div>
<div class="sourceCode" id="cb61"><html><body><pre class="r"><span class="co"># Simulated data</span>
<span class="no">x_sim</span> <span class="kw">&lt;-</span> <span class="no">samples</span>$<span class="no">x_sim</span> <span class="co"># iteration * samples * ASVs</span>
<span class="co"># Choose only the first chain</span>
<span class="no">x_sim</span> <span class="kw">&lt;-</span> <span class="no">x_sim</span>[<span class="fl">4</span>, ,] <span class="co"># For each iteration, simulated data </span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x_sim</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x_train</span>)
<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x_train</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x_train</span>)
<span class="no">ind_mibi</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x_train</span>) <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="fu">assay</span>(<span class="no">mae_train</span><span class="kw">[[</span><span class="st">"mibi"</span>]])))
<span class="no">x_sim_mibi</span> <span class="kw">&lt;-</span> <span class="no">x_sim</span>[<span class="no">ind_mibi</span>, ]
<span class="no">ind_pro</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x_train</span>) <span class="kw">%in%</span> <span class="no">proteins_not_measured_mibi</span>)
<span class="no">ind_pro_present</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(!(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x_train</span>) <span class="kw">%in%</span> <span class="no">proteins_not_measured_mibi</span>))

<span class="no">x_sim_mibi_only_measured</span> <span class="kw">&lt;-</span> <span class="no">x_train</span>[<span class="no">ind_mibi</span>, <span class="no">ind_pro_present</span>]
<span class="no">x_sim_mibi_only_measured_t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html">asinh</a></span>(<span class="no">x_sim_mibi_only_measured</span>)

<span class="no">x_sim_mibi_predict</span> <span class="kw">&lt;-</span> <span class="no">x_sim_mibi</span>
<span class="no">x_sim_mibi_predict_t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html">asinh</a></span>(<span class="no">x_sim_mibi_predict</span>)


<span class="no">manual_col</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggthemes/man/tableau_color_pal.html">tableau_color_pal</a></span>(<span class="st">"Classic 20"</span>)(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html">unique</a></span>(<span class="no">mae_train</span>$<span class="no">cell_type</span>)))


<span class="co"># UMAP of measured and predicted protein</span>
<span class="co"># UMAP of measured proteins</span>
<span class="no">mibi_umap</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/uwot/man/umap.html">umap</a></span>(<span class="no">x_sim_mibi_predict_t</span>)
<span class="no">umap_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">UMAP1</span> <span class="kw">=</span> <span class="no">mibi_umap</span>[,<span class="fl">1</span>],
                      <span class="kw">UMAP2</span> <span class="kw">=</span> <span class="no">mibi_umap</span>[,<span class="fl">2</span>],
                      <span class="kw">cell_id</span> <span class="kw">=</span> <span class="fu">colData</span>(<span class="no">mae_train</span>)$<span class="no">cell_id</span>[<span class="no">ind_mibi</span>])
<span class="no">mibi_cell_data</span> <span class="kw">&lt;-</span> <span class="fu">colData</span>(<span class="no">mae_train</span>)[<span class="no">ind_mibi</span>, ] <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>()
<span class="no">umap_df</span>  <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(<span class="no">umap_df</span>, <span class="no">mibi_cell_data</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"cell_id"</span>)

<span class="no">manual_col</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggthemes/man/tableau_color_pal.html">tableau_color_pal</a></span>(<span class="st">"Classic 20"</span>)(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html">unique</a></span>(<span class="no">mae_train</span>$<span class="no">cell_type</span>)))

<span class="no">p22</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">umap_df</span>,
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">UMAP1</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">UMAP2</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">cell_type</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">3</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(<span class="kw">values</span> <span class="kw">=</span> <span class="no">manual_col</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">color</span> <span class="kw">=</span> <span class="st">"Cell types"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"UMAP with measured and predicted proteins"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">aspect.ratio</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">plot.title</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0.5</span>))
<span class="no">p22</span></pre></body></html></div>
<div class="sourceCode" id="cb62"><html><body><pre class="r"><span class="co"># Simulated data</span>
<span class="no">x_sim</span> <span class="kw">&lt;-</span> <span class="no">samples</span>$<span class="no">x_sim</span> <span class="co"># iteration * samples * ASVs</span>
<span class="co"># Choose only the first chain</span>
<span class="no">x_sim</span> <span class="kw">&lt;-</span> <span class="no">x_sim</span>[<span class="fl">2</span>, ,] <span class="co"># For each iteration, simulated data </span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x_sim</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x_train</span>)
<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x_train</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x_train</span>)
<span class="no">ind_mibi</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rownames</a></span>(<span class="no">x_train</span>) <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="fu">assay</span>(<span class="no">mae_train</span><span class="kw">[[</span><span class="st">"mibi"</span>]])))
<span class="no">x_sim_mibi</span> <span class="kw">&lt;-</span> <span class="no">x_sim</span>[<span class="no">ind_mibi</span>, ]
<span class="no">ind_pro</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x_train</span>) <span class="kw">%in%</span> <span class="no">proteins_not_measured_mibi</span>)
<span class="no">ind_pro_present</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(!(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">x_train</span>) <span class="kw">%in%</span> <span class="no">proteins_not_measured_mibi</span>))

<span class="no">x_sim_mibi_only_measured</span> <span class="kw">&lt;-</span> <span class="no">x_train</span>[<span class="no">ind_mibi</span>, <span class="no">ind_pro_present</span>]
<span class="no">x_sim_mibi_only_measured_t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html">asinh</a></span>(<span class="no">x_sim_mibi_only_measured</span>)

<span class="no">x_sim_mibi_predict</span> <span class="kw">&lt;-</span> <span class="no">x_sim_mibi</span>
<span class="no">x_sim_mibi_predict_t</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html">asinh</a></span>(<span class="no">x_sim_mibi_predict</span>)



<span class="no">manual_col</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggthemes/man/tableau_color_pal.html">tableau_color_pal</a></span>(<span class="st">"Classic 20"</span>)(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html">unique</a></span>(<span class="no">mae_train</span>$<span class="no">cell_type</span>)))


<span class="co"># UMAP of measured and predicted protein</span>
<span class="co"># UMAP of measured proteins</span>
<span class="no">mibi_umap</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/uwot/man/umap.html">umap</a></span>(<span class="no">x_sim_mibi_predict_t</span>)
<span class="no">umap_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">UMAP1</span> <span class="kw">=</span> <span class="no">mibi_umap</span>[,<span class="fl">1</span>],
                      <span class="kw">UMAP2</span> <span class="kw">=</span> <span class="no">mibi_umap</span>[,<span class="fl">2</span>],
                      <span class="kw">cell_id</span> <span class="kw">=</span> <span class="fu">colData</span>(<span class="no">mae_train</span>)$<span class="no">cell_id</span>[<span class="no">ind_mibi</span>])
<span class="no">mibi_cell_data</span> <span class="kw">&lt;-</span> <span class="fu">colData</span>(<span class="no">mae_train</span>)[<span class="no">ind_mibi</span>, ] <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>()
<span class="no">umap_df</span>  <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(<span class="no">umap_df</span>, <span class="no">mibi_cell_data</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"cell_id"</span>)

<span class="no">manual_col</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ggthemes/man/tableau_color_pal.html">tableau_color_pal</a></span>(<span class="st">"Classic 20"</span>)(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html">unique</a></span>(<span class="no">mae_train</span>$<span class="no">cell_type</span>)))

<span class="no">p23</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">umap_df</span>,
       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">UMAP1</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">UMAP2</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">cell_type</span>)) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">size</span> <span class="kw">=</span> <span class="fl">3</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>() +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(<span class="kw">values</span> <span class="kw">=</span> <span class="no">manual_col</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">color</span> <span class="kw">=</span> <span class="st">"Cell types"</span>)+
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"UMAP with measured and predicted proteins"</span>) +
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">aspect.ratio</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">plot.title</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(<span class="kw">hjust</span> <span class="kw">=</span> <span class="fl">0.5</span>))
<span class="no">p23</span></pre></body></html></div>
<div class="sourceCode" id="cb63"><html><body><pre class="r"><span class="no">com_p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span>(<span class="no">p1</span>, <span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">arrangeGrob</a></span>(<span class="no">p22</span>, <span class="no">p23</span>, <span class="kw">ncol</span><span class="kw">=</span><span class="fl">1</span>), <span class="kw">ncol</span><span class="kw">=</span><span class="fl">2</span>, <span class="kw">widths</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">1.2</span>))


<span class="co"># ggsave("predicted_mibi_protein.png", com_p, width = 20, height = 15)</span></pre></body></html></div>
<p>The clusters of cells are clearly identified when using observed and predicted protein expressions.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p><a href="mailto:jpratheepa31@gmail.com" class="email">jpratheepa31@gmail.com</a><a href="#fnref1" class="footnote-back">â†©</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Pratheepa Jeganathan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.0.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
